{% extends "layout.html" %}

{% block title %}
    Portfolio
{% endblock %}

{% block main %}
<div class="container-fluid bg-dark text-center rounded p-4 shado opacity-75 table-responsive-sm">
<table class="table table-dark table-hover">
    <thead>
        <tr>
            <th class="text-start">Symbol</th>
            <th class="text-start">Name</th>
            <th class="text-end">Shares Owned</th>
            <th class="text-end">Current Price (per share)</th>
            <th class="text-end">TOTAL</th>
        </tr>
    </thead>
    <tbody>
        {% for stock in portfolio %}
            <tr>
                <td class="text-start">{{stock.stock_symbol}}</td>
                <td class="text-start">{{stock.stock_name}}</td>
                <td class="text-end">{{stock.num_shares}}</td>
                <td class="text-end">{{stock.price | usd}}</td>
                <td class="text-end">{{(stock.price * stock.num_shares) | usd}}</td>
            </tr>
        {% endfor %}

</tbody>
    <tfoot>
        <tr>
            <td class="border-0 fw-bold text-end" colspan="4">Starting amount</td>
            <td class="border-0 text-end">$10,000.00</td>
        </tr>
        <tr>
            <td class="border-0 fw-bold text-end" colspan="4">Total Portfolio Value</td>
            <td class="border-0 w-bold text-end">{{total}}</td>
        </tr>
        <tr>
            <td class="border-0 fw-bold text-end" colspan="4">Available Funds</td>
            <td class="border-0 text-end">{{cash}}</td>
        </tr>
        <tr>
            <td class="border-0 fw-bold text-end" colspan="4">Total P&L</td>
            <td class="border-0 text-end">{{pl}}</td>
        </tr>
        <tr>
            <td class="border-0 fw-bold text-end" colspan="4">Percentage P&L</td>
            <td class="border-0 text-end">{{percent_pl}}%</td>
        </tr>
    </tfoot>
</table>
    <div class="d-flex justify-content-xl-between container-fluid flex-sm-column flex-xl-row flex-lg-row flex-md-row flex-column">
        <form action="/buy" method="post">
            <div class="mb-3">
                <input autocomplete="off" autofocus class="form-control mx-auto w-auto" name="symbol" placeholder="Symbol" type="text">
            </div>
            <div class="mb-3">
                <input class="form-control mx-auto w-auto" name="shares" min = "1" placeholder="Number Of Shares" type="number">
            </div>
            <button class="btn btn-primary" type="submit">Buy</button>
        </form>
        <br>
        <form action="/quote" method="post">
            <div class="mb-3">
                <input autocomplete="off" autofocus class="form-control mx-auto w-auto" id="symbol" name="symbol" placeholder="Symbol" type="text">
            </div>
            <br>
            <div>
                <button class="btn btn-primary" type="submit">Get more info about this stock</button>
            </div>
        </form>
        <br>
        <form action="/sell" method="post">
            <div class="mb-3">
                <select name = symbol placeholder = "Symbol">
                    {% for stock in portfolio %}
                        <option value = "{{stock.stock_symbol}}">{{stock.stock_symbol}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <input class="form-control mx-auto w-auto" name="shares" min = "1" placeholder="Number Of Shares" type="number">
            </div>
            <button class="btn btn-primary" type="submit">Sell</button>
        </form>
    </div>
</div>
<br>
<div class="container-fluid rounded p-4 shad opacity-75">
    <div class="row g-4">
        <div class="col-sm-12 col-xl-8">
            <div class="bg-light text-center text-light rounded p-4 shadow">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h6 class="mb-0">Market Feed</h6>
                    <div>
                        <select class="form-select" aria-label="Default select example">
                            <option selected>Latest</option>
                        </select>
                    </div>
                </div>
                <!-- <canvas id="worldwide-sales"></canvas> -->
                <img id="news1_img">
                <h5 id="news1"></h5>
                <img id="news2_img">
                <h5 id="news2"></h5>
                <img id="news3_img">
                <h5 id="news3"></h5>
                <!-- <img src="static/img/feed.png" alt="Market Feed" class="container-fluid"> -->
            </div>
        </div>
        <div class="col-sm-12 col-xl-4">
            <div class="bg-light text-center rounded p-4 shadow h-100">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h6 class="mb-0">Historical Performance of assets in portfolio</h6>
                    <div>
                        <select id="time" class="form-select" aria-label="Default select example">
                            <option value="month" selected>Past Month</option>
                            <option value="year">Past Year</option>
                        </select>
                    </div>
                </div>
                <div class="w-100 d-flex justify-content-center">
                    <div id="container" style="height: 370px; width: 450px;">
                        {% for symbol in assets %}
                            <div id ="{{symbol}}" class="w-100 d-flex justify-content-center container"></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>    
<script>
    url = `https://financialmodelingprep.com/api/v3/quote/{symbol}?apikey=6fbceaefb411ee907e9062098ef0fd66`

    // Get today's date
    const today = new Date();

    // Get yesterday's date
    const endDate = new Date(today);
    endDate.setDate(endDate.getDate());

    // Get the date one month ago
    let startDate = new Date(today);
    let choice = document.querySelector("#time");
    let symbols = {{assets | tojson}};
    console.log(typeof symbols)
    startDate.setMonth(startDate.getMonth() - 1);
    const tempStartData = startDate.toISOString().split('T')[0];
    const tempEndData = endDate.toISOString().split('T')[0];
    console.log(tempStartData, tempEndData)
    async function fetchStockDataMonth(symbol, formattedStartDate, formattedEndDate) {
        const response = await fetch(`https://financialmodelingprep.com/api/v3/historical-price-full/${symbol}?from=${formattedStartDate}&to=${formattedEndDate}&apikey=6fbceaefb411ee907e9062098ef0fd66`);
        const data = await response.json();
        return data.historical;
    }

    async function calculateMovingAverage(symbol, formattedStartDate, formattedEndDate) {
        const response = await fetch(`https://financialmodelingprep.com/api/v3/technical_indicator/1day/${symbol}?type=sma&period=10&from=${formattedStartDate}&to=${formattedEndDate}&apikey=6fbceaefb411ee907e9062098ef0fd66`);
        const data = await response.json();
        return data
    }

    async function renderCandlestickChart(data, symbol, start, end) {
        const trace = {
            x: data.map(item => item.date),
            close: data.map(item => item.close),
            high: data.map(item => item.high),
            low: data.map(item => item.low),
            open: data.map(item => item.open),
    
            // Customization of the candlestick chart
            increasing: { line: { color: 'green' } },
            decreasing: { line: { color: 'red' } },
            
            type: 'candlestick',
            name: `${symbol}`
        };

        const vwapDataTrace = {
            x: data.map(item => item.date),
            y: data.map(item => item.vwap),
            type: 'scatter',
            mode: 'lines',
            name: 'vwap'
        }

        // Fetch the SMA data
        const movingAverageData = await calculateMovingAverage(symbol, start, end);
        // Create a new trace for the SMA
        const movingAverageTrace = {
            x: movingAverageData.map(item => item.date),
            y: movingAverageData.map(item => item.sma),
            type: 'scatter',
            mode: 'lines',
            name: '10-day SMA'
        };
    
        const layout = {
            title: `${symbol} Perfomance`,
            xaxis: {
                type: 'date',
                title: 'Date'
            },
            yaxis: {
                autorange: true,
                title: 'Stock Price'
            }
        };
    
        Plotly.newPlot(symbol, [trace, movingAverageTrace, vwapDataTrace], layout);
    }

    symbols.forEach(symbol => fetchStockDataMonth(symbol, tempStartData, tempEndData).then(data => {renderCandlestickChart(data, symbol, tempStartData, tempEndData)}).catch(err => console.log(err)));
    choice.onchange = async () => {
        if (choice.value === "month") {
            startDate = new Date(today);
            startDate.setMonth(startDate.getMonth() - 1);
            month = true;
        } else {
            startDate = new Date(today);
            startDate.setFullYear(startDate.getFullYear() - 1);
            month = false;
        }

        // Format the dates as YYYY-MM-DD
        const formattedStartDate = startDate.toISOString().split('T')[0];
        const formattedEndDate = endDate.toISOString().split('T')[0];
        console.log(formattedStartDate,formattedEndDate)
        symbols.forEach(symbol => fetchStockDataMonth(symbol, formattedStartDate, formattedEndDate).then(data => {renderCandlestickChart(data, symbol, formattedStartDate, formattedEndDate)}).catch(err => console.log(err)));
    }
    function restartAnimation(element) {
        // Remove the class
        element.classList.remove('slide-in');
    
        // Force a reflow/repaint
        void element.offsetWidth;
    
        // Re-add the class
        element.classList.add('slide-in');
    }
    function updateNews() {
        fetch(`https://stocknewsapi.com/api/v1/category?section=general&items=3&page=1&token=qvgfptpokzmfkdag1opnwj9c2svtukxyseprol1n`)
        .then(response => response.json())
        .then(result => {
        const news1 = document.querySelector("#news1")
        const news1Image = document.querySelector("#news1_img")
        const news2 = document.querySelector("#news2")
        const news2Image = document.querySelector("#news2_img")
        const news3 = document.querySelector("#news3")
        const news3Image = document.querySelector("#news3_img")
        news1.innerHTML = result.data[0]["title"] + "<div>Date: " + result.data[0]["date"] + "</div>" + "<div style='color:green'>Sentiment: " + result.data[0]["sentiment"] + "</div>" + "\nLink to article: " + "<a style='color:blue' href=" + result.data[0]["news_url"] + ">" + result.data[0]["news_url"] + "</a>"
        news1Image.src = result.data[0]["image_url"]
        news1.classList.add('slide-in');
        news1.classList.add('news');
        news1Image.classList.add('slide-in');
        news1Image.classList.add('news');
        news2.innerHTML = result.data[1]["title"] + "<div>Date: " + result.data[1]["date"] + "</div>" + "<div style='color:green'>Sentiment: " + result.data[1]["sentiment"] + "</div>" + "\nLink to article: " + "<a style='color:blue' href=" + result.data[1]["news_url"] + ">" + result.data[1]["news_url"] + "</a>"
        news2Image.src = result.data[1]["image_url"]
        news2.classList.add('slide-in');
        news2.classList.add('news');
        news2Image.classList.add('slide-in');
        news2Image.classList.add('news');
        news3.innerHTML = result.data[2]["title"] + "<div>Date: " + result.data[2]["date"] + "</div>" + "<div style='color:green'>Sentiment: " + result.data[2]["sentiment"] + "</div>" + "\nLink to article: " + "<a style='color:blue' href=" + result.data[2]["news_url"] + ">" + result.data[2]["news_url"] + "</a>"
        news3Image.src = result.data[2]["image_url"]
        news3.classList.add('slide-in');
        news3.classList.add('news');
        news3Image.classList.add('slide-in');
        news3Image.classList.add('news');
    })
        .catch(err => console.log(err))
    };
    document.addEventListener("DOMContentLoaded", () => {
        
        updateNews();
        setInterval(updateNews, 300000); // Update every 5 minutes
    });

</script>
{% endblock %}
