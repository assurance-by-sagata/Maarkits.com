{% extends "layout.html" %}

{% block title %}
    Quote
{% endblock %}

{% block main %}
    <div class="bg-dark text-center rounded p-4 shadow text-light opacity-75">
        The current share price of {{stock.symbol}}({{stock.name}}) is {{stock.price | usd}}
    </div>
    <br>
    <div class="row g-4">
        <div class="col-sm-12 col-xl-8">
            <div class="bg-light text-center text-light rounded p-4 shadow opacity-75">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h6 class="mb-0">{{stock.name}} Market Feed</h6>
                    <div>
                        <select class="form-select" aria-label="Default select example">
                            <option selected>Today</option>
                        </select>
                    </div>
                </div>
                <!-- <canvas id="worldwide-sales"></canvas> -->
                <img id="news1_img">
                <h5 id="news1"></h5>
                <img id="news2_img">
                <h5 id="news2"></h5>
                <img id="news3_img">
                <h5 id="news3"></h5>
                <img id="news4_img">
                <h5 id="news4"></h5>
                <!-- <img src="static/img/feed.png" alt="Market Feed" class="container-fluid"> -->
            </div>
        </div>
        <div class="col-sm-12 col-xl-4">
            <div class="bg-light text-center rounded p-4 shadow h-100 opacity-75">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h6 class="mb-0">{{stock.name}} Historical Performance</h6>
                    <div>
                        <select class="form-select" aria-label="Default select example">
                            <option selected>Past Month</option>
                            <option value="1">Past Year</option>
                        </select>
                    </div>
                </div>
                <div class="w-100 d-flex justify-content-center">
                    <div id="container" style="height: 370px; width: 450px;">
                        <div>
                            <canvas id="stockChart" width="400" height="400"></canvas>
                            <canvas id="percentChart" width="400" height="400"></canvas>
                        </div>
                        <br>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
       // Get today's date
        const today = new Date();

        // Get yesterday's date
        const endDate = new Date(today);
        endDate.setDate(endDate.getDate() - 1);

        // Get the date one month ago
        const startDate = new Date(today);
        startDate.setMonth(startDate.getMonth() - 1);

        // Format the dates as YYYY-MM-DD
        const formattedStartDate = startDate.toISOString().split('T')[0];
        const formattedEndDate = endDate.toISOString().split('T')[0];
        console.log(formattedStartDate,formattedEndDate)
        let symbol = "{{stock.symbol}}"
        function updateNews() {
            fetch(`https://stocknewsapi.com/api/v1?tickers=${symbol}&items=4&page=1&token=qvgfptpokzmfkdag1opnwj9c2svtukxyseprol1n`)
            .then(response => response.json())
            .then(result => {
            const news1 = document.querySelector("#news1")
            const news1Image = document.querySelector("#news1_img")
            const news2 = document.querySelector("#news2")
            const news2Image = document.querySelector("#news2_img")
            const news3 = document.querySelector("#news3")
            const news3Image = document.querySelector("#news3_img")
            const news4 = document.querySelector("#news4")
            const news4Image = document.querySelector("#news4_img")
            news1.innerHTML = result.data[0]["title"] + "<div>Date: " + result.data[0]["date"] + "</div>" + "<div style='color:green'>Sentiment: " + result.data[0]["sentiment"] + "</div>" + "\nLink to article: " + "<a style='color:blue' href=" + result.data[0]["news_url"] + ">" + result.data[0]["news_url"] + "</a>"
            news1Image.src = result.data[0]["image_url"]
            news1.classList.add('slide-in');
            news1.classList.add('news');
            news1Image.classList.add('slide-in');
            news1Image.classList.add('news');
            news2.innerHTML = result.data[1]["title"] + "<div>Date: " + result.data[1]["date"] + "</div>" + "<div style='color:green'>Sentiment: " + result.data[1]["sentiment"] + "</div>" + "\nLink to article: " + "<a style='color:blue' href=" + result.data[1]["news_url"] + ">" + result.data[1]["news_url"] + "</a>"
            news2Image.src = result.data[1]["image_url"]
            news2.classList.add('slide-in');
            news2.classList.add('news');
            news2Image.classList.add('slide-in');
            news2Image.classList.add('news');
            news3.innerHTML = result.data[2]["title"] + "<div>Date: " + result.data[2]["date"] + "</div>" + "<div style='color:green'>Sentiment: " + result.data[2]["sentiment"] + "</div>" + "\nLink to article: " + "<a style='color:blue' href=" + result.data[2]["news_url"] + ">" + result.data[2]["news_url"] + "</a>"
            news3Image.src = result.data[2]["image_url"]
            news3.classList.add('slide-in');
            news3.classList.add('news');
            news3Image.classList.add('slide-in');
            news3Image.classList.add('news');
            news4.innerHTML = result.data[3]["title"] + "<div>Date: " + result.data[3]["date"] + "</div>" + "<div style='color:green'>Sentiment: " + result.data[3]["sentiment"] + "</div>" + "\nLink to article: " + "<a style='color:blue' href=" + result.data[3]["news_url"] + ">" + result.data[3]["news_url"] + "</a>"
            news4Image.src = result.data[3]["image_url"]
            news4.classList.add('slide-in');
            news4.classList.add('news');
            news4Image.classList.add('slide-in');
            news4Image.classList.add('news');
        })
            .catch(err => console.log(err))
        };
        document.addEventListener("DOMContentLoaded", () => {

            updateNews();
            setInterval(updateNews, 3000000); // Update every 5 minutes
        });

        async function fetchStockDataMonth() {
            const response = await fetch(`https://financialmodelingprep.com/api/v3/historical-price-full/AAPL?from=2023-11-11&to=2023-12-10&apikey=6fbceaefb411ee907e9062098ef0fd66`);
            const data = await response.json();
            return data.historical;
        }
        
        function renderChart(data) {
            const reversedData = [...data].reverse();
            const ctx = document.getElementById('stockChart').getContext('2d');
            const chartData = {
                labels: reversedData.map(item => item.date),
                datasets: [{
                    label: 'Stock Price',
                    data: reversedData.map(item => item.close),
                    borderColor: 'blue',
                    backgroundColor: 'rgba(0, 0, 255, 0.1)',
                }]
            };
        
            new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    },
                    legend: {
                        onClick: function (e) {
                            e.stopPropagation();
                        }// Disable legend click functionality
                    }
                }
            });
        }

        function renderPercent(data) {
            const reversedData = [...data].reverse();
            const ctx = document.getElementById('percentChart').getContext('2d');
            const chartData = {
                labels: reversedData.map(item => item.date),
                datasets: [{
                    label: 'Percent Change',
                    data: reversedData.map(item => item.changePercent),
                    borderColor: 'purple',
                    backgroundColor: 'rgba(0, 0, 255, 0.1)',
                }]
            };
        
            new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    },
                    legend: {
                        onClick: function (e) {
                            e.stopPropagation();
                        }// Disable legend click functionality
                    }
                }
            });
        }
        
        fetchStockDataMonth().then(data => {renderPercent(data), renderChart(data), render});
        
    </script>
{% endblock %}
